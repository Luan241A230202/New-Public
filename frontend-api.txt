TỔNG QUAN FRONTEND API (External) — Dành cho Bolt/Lovable/Expo

Mục tiêu: dùng chung backend Next.js, cho phép nhiều frontend/app qua API key + JWT.

1) Xác thực ứng dụng (API Key)
- Bắt buộc header: X-API-Key: <raw key>
- Admin tạo key: POST /api/admin/api-keys
- Allowlist domain: cấu hình allowedOrigins (csv) trong API key
  Ví dụ: "app.domain.com,*.vercel.app,https://myapp.web.app"
- Khi request có Origin → backend kiểm tra allowlist

2) Xác thực người dùng (JWT)
- JWT cookie (browser): credentials: "include"
- JWT Bearer (mobile/expo): Authorization: Bearer <token>
- Đăng nhập external: POST /api/external/auth/login
  Body: { "email": "...", "password": "..." }
  Response: { ok, access_token, user }
- Đăng ký external: POST /api/external/auth/register
- Đăng xuất external: POST /api/external/auth/logout

3) Scopes (bắt buộc nếu strictScopes = true)
Ví dụ scope:
- public/videos
- public/search
- auth/login | auth/register | auth/me
- me/notifications | me/watch-later
- stars/topup/intent | stars/topup/history
- nft/write | user/write

4) Ví dụ: Public videos
GET /api/external/public/videos?take=12&page=1
Headers:
  X-API-Key: <key>
Response:
  { ok, items: [{ id, title, thumbUrl, watchUrl, ... }], page, take, total }

5) Ví dụ: Search
GET /api/external/public/search?q=music
Headers: X-API-Key

6) Ví dụ: Đăng nhập + lấy token
POST /api/external/auth/login
Headers: X-API-Key
Body: { "email": "demo@site.com", "password": "123456" }
Response: { ok, access_token, user }

7) Topup Stars (USDT/USDC)
- Tạo intent:
POST /api/external/stars/topup/intent
Headers: X-API-Key + Authorization: Bearer <token> (hoặc cookie)
Body: { "packageId": "<id>", "couponCode": "..." }
Response: { ok, deposit: { id, chain, toAddress, memo, expectedAmount, stars } }

- Lịch sử nạp:
GET /api/external/stars/topup/history
Headers: X-API-Key + Authorization: Bearer <token>

8) NFT marketplace
- Create listing: POST /api/external/nft/listings/create (scope: nft/write + user/write)
- Cancel listing: POST /api/external/nft/listings/cancel
- Buy listing: POST /api/external/nft/listings/buy

9) Cookie + CORS
- Browser: fetch(url, { credentials: "include" })
- CORS allowlist: config allowedOrigins trong API key

10) WalletScan / Ledger (đã triển khai)
- GET /api/external/wallet-scan/search (username/userId/address/txHash/contractAddress)
- Trả về: user, wallets, ledger (sao + nạp), deposits, star tx
- Bổ sung: nftItems, nftListings, nftAuctions, nftSales, nftEventLogs (đã triển khai)
- Bổ sung: walletAssets, payoutLedger (placeholder)
 - GET /api/external/wallet-scan/tx/{hash} (tra nhanh theo txHash)
 - GET /api/external/wallet-scan/user/{username} (tra theo username + phân trang)
 - GET /api/external/wallet-scan/contracts (danh sách contract export)
 - GET /api/external/wallet-scan/contract/{chain}/{address} (chi tiết contract)
 - GET /api/external/wallet-scan/wallets?username=...
 - GET /api/external/wallet-scan/assets?username=...&chain=...
 - GET /api/external/wallet-scan/nfts?username=...
 - GET /api/external/wallet-scan/ledger?username=...

11) Gợi ý bổ sung endpoint theo module
- Billing/Subscription (đề xuất):
  - GET /api/external/billing/plans
  - POST /api/external/billing/subscribe
  - POST /api/external/billing/cancel
  - GET /api/external/billing/invoices
- Wallet/History (đề xuất):
  - GET /api/external/wallets/history
  - GET /api/external/wallets/balances
  - POST /api/external/wallets/withdraw
- Multi-chain status (đề xuất):
  - GET /api/external/chains/status
  - GET /api/external/chains/confirmations
- Live/Streaming (đề xuất):
  - POST /api/external/live/ingest
  - GET /api/external/live/{id}
  - POST /api/external/live/{id}/stop
- Moderation queue (đề xuất):
  - GET /api/admin/moderation/queue
  - POST /api/admin/moderation/{id}/approve
  - POST /api/admin/moderation/{id}/reject
- Webhook system (đề xuất):
  - POST /api/admin/webhooks
  - GET /api/admin/webhooks
  - POST /api/admin/webhooks/{id}/test
- Analytics (đề xuất):
  - GET /api/admin/analytics/overview
  - GET /api/external/analytics/me
 - Referral / Creator stats / AI moderation / Payout (đã triển khai):
   - GET /api/external/referrals/me
   - POST /api/external/referrals/claim
   - GET /api/external/creator-stats/summary
   - GET /api/external/creator-stats/revenue
   - GET /api/external/creator-stats/top-fans
   - GET /api/admin/moderation/ai/queue
   - POST /api/admin/moderation/ai/{id}/decision
   - GET /api/admin/moderation/ai/status
   - GET /api/external/payouts/methods
   - POST /api/external/payouts/request
   - GET /api/external/payouts/{id}
 - Live/Streaming (đã triển khai):
   - GET /api/external/live/streams
   - POST /api/external/live/streams
   - GET /api/external/live/streams/{id}
   - POST /api/external/live/streams/{id}/start
   - POST /api/external/live/streams/{id}/stop
   - GET /api/external/live/streams/{id}/chat
   - POST /api/external/live/streams/{id}/chat
